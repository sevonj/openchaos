name: Merge top-voted PR weekly

on:
  schedule:
    - cron: "0 12 * * 0"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-top-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Merge highest-voted PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function getOpenPRs() {
              const prs = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                per_page: 100
              });

              const prsWithVotes = await Promise.all(
                prs.data.map(async (pr) => {
                  const reactions = await github.rest.reactions.listForIssue({
                    owner,
                    repo,
                    issue_number: pr.number,
                    per_page: 100
                  });

                  const votes = reactions.data.filter(r => r.content === '+1').length;

                  return {
                    number: pr.number,
                    title: pr.title,
                    author: pr.user.login,
                    votes
                  };
                })
              );

              prsWithVotes.sort((a,b) => b.votes - a.votes);

              return prsWithVotes;
            }

            const openPRs = await getOpenPRs();
            if (openPRs.length === 0) {
              console.log("No open PRs found.");
              return;
            }

            const topPR = openPRs[0];
            console.log(`Top PR (#${topPR.number}) by @${topPR.author}: ${topPR.title} with ${topPR.votes} votes`);

            if (topPR.votes === 0) {
              console.log("No votes â€” skipping merge.");
              return;
            }

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: topPR.number,
              merge_method: 'squash',
            });

            console.log(`Merged PR #${topPR.number}`);
